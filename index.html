<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heat Safety Dashboard</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap');
:root{--sky1:#3a7bd5;--card:rgba(255,255,255,0.12);--card-solid:rgba(100,160,220,0.25);--glass:rgba(255,255,255,0.08);--border:rgba(255,255,255,0.15);--border-light:rgba(255,255,255,0.25);--txt:#fff;--txt2:rgba(255,255,255,0.75);--txt3:rgba(255,255,255,0.5);--safe:#4cd9a0;--caution:#ffc857;--danger:#ff6b6b;--rain:#70b8ff}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito',sans-serif;min-height:100vh;background:linear-gradient(175deg,#2a5da8 0%,#3a7bd5 20%,#5b9ce6 45%,#7eb8f0 70%,#a8d4f7 100%);color:var(--txt);overflow-x:hidden}
.app{max-width:800px;margin:0 auto;padding:20px 16px 60px}
.header{text-align:center;padding:24px 0 8px}
.header h1{font-size:28px;font-weight:900;letter-spacing:-.5px;margin-bottom:2px}
.header-loc{font-size:14px;color:var(--txt2);font-weight:500}
.loc-bar{display:flex;gap:8px;margin:16px 0;background:var(--card);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:16px;padding:6px}
.loc-input{flex:1;padding:10px 14px;background:0 0;border:none;color:var(--txt);font-family:'Nunito',sans-serif;font-size:14px;font-weight:500;outline:0}
.loc-input::placeholder{color:var(--txt3)}
.loc-btn{padding:10px 18px;background:rgba(255,255,255,.15);border:1px solid var(--border);border-radius:12px;color:var(--txt);font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap}
.loc-btn:hover{background:rgba(255,255,255,.25)}.loc-btn:disabled{opacity:.5}
.loc-gps{padding:10px 14px;background:rgba(255,255,255,.1);border:1px solid var(--border);border-radius:12px;color:var(--txt);font-size:16px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
.loc-gps:hover{background:rgba(255,255,255,.2)}
.now-card{background:var(--card-solid);backdrop-filter:blur(30px);border:1px solid var(--border-light);border-radius:24px;padding:28px 24px;margin-bottom:12px;position:relative;overflow:hidden}
.now-card::before{content:'';position:absolute;top:-50%;right:-30%;width:200px;height:200px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,.08) 0%,transparent 70%)}
.now-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;position:relative}
.now-temp{font-size:72px;font-weight:900;line-height:1;letter-spacing:-3px}
.now-right{text-align:right}
.now-hi{font-size:16px;font-weight:700;margin-bottom:4px}
.now-hi-val{font-size:32px;font-weight:900;line-height:1}
.now-label{font-size:11px;color:var(--txt3);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-top:4px}
.now-status{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:12px;font-size:13px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;margin-top:12px}
.now-status.safe{background:rgba(76,217,160,.2);color:var(--safe)}
.now-status.caution{background:rgba(255,200,87,.2);color:var(--caution)}
.now-status.danger{background:rgba(255,107,107,.2);color:var(--danger)}
.now-status-dot{width:10px;height:10px;border-radius:50%;animation:pulse 2s infinite}
.now-status.safe .now-status-dot{background:var(--safe)}
.now-status.caution .now-status-dot{background:var(--caution)}
.now-status.danger .now-status-dot{background:var(--danger)}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(255,255,255,.3)}50%{box-shadow:0 0 0 6px rgba(255,255,255,0)}}
.now-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:rgba(255,255,255,.06);border-radius:16px;overflow:hidden;margin-top:20px}
.now-stat{background:rgba(255,255,255,.04);padding:14px 8px;text-align:center}
.now-stat-icon{font-size:20px;margin-bottom:4px}
.now-stat-val{font-size:16px;font-weight:800;font-family:'JetBrains Mono',monospace}
.now-stat-lbl{font-size:10px;color:var(--txt3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.src-line{text-align:center;font-size:11px;color:var(--txt3);font-weight:500;padding:8px 0 16px;font-family:'JetBrains Mono',monospace}
.src-tag{display:inline-block;padding:2px 8px;border-radius:6px;font-weight:700;font-size:10px;letter-spacing:.5px}
.src-tag.google{background:rgba(255,255,255,.15);color:#fff}
.src-tag.meteo{background:rgba(76,217,160,.2);color:var(--safe)}
.src-tag.embed{background:rgba(255,200,87,.2);color:var(--caution)}
.card{background:var(--card);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:12px}
.card-title{font-size:13px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--txt2);margin-bottom:16px}
.tabs{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch;margin-bottom:16px}
.tab{flex-shrink:0;padding:10px 14px;border-radius:14px;background:var(--glass);border:1px solid transparent;color:var(--txt2);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;text-align:center;min-width:80px}
.tab:hover{background:rgba(255,255,255,.12)}
.tab.on{background:rgba(255,255,255,.2);border-color:var(--border-light);color:#fff;font-weight:800}
.tab .td{font-size:10px;display:block;margin-top:2px;color:var(--txt3);font-family:'JetBrains Mono',monospace}
.tab .tt{font-size:12px;display:block;margin-top:4px;font-weight:800}
.tab.today{border-color:rgba(76,217,160,.4)}.tab.today.on{border-color:var(--safe)}
.badge{font-size:8px;background:var(--safe);color:#1a4d2e;padding:2px 6px;border-radius:6px;font-weight:800;letter-spacing:.5px;margin-left:4px}
.hourly-scroll{display:flex;gap:2px;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch}
.hour-col{flex-shrink:0;width:56px;padding:10px 4px;border-radius:14px;text-align:center;transition:all .2s;background:0 0}
.hour-col.danger{background:rgba(255,107,107,.12)}.hour-col.caution{background:rgba(255,200,87,.12)}
.hour-col.now{background:rgba(255,255,255,.15);border:1px solid var(--border-light)}
.hour-time{font-size:12px;font-weight:700;color:var(--txt2);margin-bottom:6px}
.hour-icon{font-size:18px;margin-bottom:4px}
.hour-temp{font-size:15px;font-weight:800}
.hour-hi{font-size:10px;color:var(--txt3);margin-top:2px;font-family:'JetBrains Mono',monospace}
.hour-rain{font-size:10px;color:var(--rain);font-weight:600;margin-top:2px}
.safety-bar{height:28px;border-radius:14px;display:flex;overflow:hidden;margin-bottom:8px}
.safety-seg{display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;color:rgba(0,0,0,.4)}
.safety-seg.safe{background:var(--safe)}.safety-seg.caution{background:var(--caution)}.safety-seg.danger{background:var(--danger)}
.safety-labels{display:flex;justify-content:space-between;padding:0 4px}
.safety-lbl{font-size:10px;color:var(--txt3);font-family:'JetBrains Mono',monospace}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:12px 0}
.stat-box{background:var(--glass);border-radius:14px;padding:14px 8px;text-align:center;border:1px solid rgba(255,255,255,.06)}
.stat-val{font-size:24px;font-weight:900}.stat-lbl{font-size:10px;color:var(--txt3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.chart-wrap{width:100%;overflow-x:auto;padding-bottom:4px}.chart-wrap svg{display:block;width:100%;min-width:600px;height:auto}
.chart-legend{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px}
.chart-lg{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--txt2);font-weight:600}
.chart-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.tooltip{position:fixed;background:rgba(30,60,110,.95);backdrop-filter:blur(16px);border:1px solid var(--border-light);border-radius:14px;padding:14px 16px;font-size:13px;pointer-events:none;z-index:100;opacity:0;transition:opacity .2s;max-width:240px}
.tooltip.on{opacity:1}
.tt-title{font-weight:800;font-size:13px;margin-bottom:6px;font-family:'JetBrains Mono',monospace}
.tt-r{display:flex;justify-content:space-between;gap:12px;margin:3px 0;color:var(--txt2)}.tt-r .v{color:#fff;font-weight:700}
.act-list{display:flex;flex-direction:column;gap:8px}
.act-item{display:flex;align-items:center;gap:14px;background:var(--glass);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:14px 16px;transition:all .2s}
.act-item:hover{background:rgba(255,255,255,.1)}
.act-dot{width:6px;height:36px;border-radius:3px;flex-shrink:0}
.act-dot.safe{background:var(--safe)}.act-dot.caution{background:var(--caution)}.act-dot.danger{background:var(--danger)}
.act-time{font-size:11px;font-weight:700;color:var(--txt3);font-family:'JetBrains Mono',monospace;min-width:100px}
.act-name{font-size:14px;font-weight:700;flex:1}
.act-tags{display:flex;gap:4px;flex-wrap:wrap}
.act-tag{font-size:9px;padding:3px 8px;border-radius:8px;font-weight:700;background:rgba(255,255,255,.1);color:var(--txt2)}
.footer{text-align:center;padding:24px 0;font-size:11px;color:var(--txt3);font-weight:500}.footer a{color:var(--txt2);text-decoration:none}
.loading{display:flex;align-items:center;justify-content:center;gap:10px;padding:40px;color:var(--txt2);font-weight:600}
.spinner{width:18px;height:18px;border:2px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:600px){.now-temp{font-size:56px}.now-hi-val{font-size:26px}.stats-row,.now-grid{grid-template-columns:repeat(2,1fr)}.act-item{flex-wrap:wrap}.act-time{min-width:auto}}
</style>
</head>
<body>
<div id="tip" class="tooltip"></div>
<div class="app">
  <header class="header"><h1>Heat Safety</h1><div class="header-loc" id="header-loc">Phuket, Thailand</div></header>
  <div class="loc-bar"><input type="text" class="loc-input" id="loc-input" placeholder="Search city or location‚Ä¶" value="Phuket, Thailand"><button class="loc-btn" id="loc-btn" onclick="searchLocation()">Search</button><button class="loc-gps" onclick="useMyLocation()" title="Use my location">üìç</button></div>
  <div id="now-card" class="now-card" style="display:none"></div>
  <div class="src-line" id="src-line"></div>
  <div class="card"><div class="card-title">7-Day Forecast</div><div class="tabs" id="tabs"></div><div id="hourly-area"><div class="loading"><div class="spinner"></div>Loading‚Ä¶</div></div></div>
  <div class="card"><div class="card-title">Safety Timeline</div><div id="safety-bar"></div><div class="stats-row" id="stats-row"></div></div>
  <div class="card"><div class="card-title">Temperature & Conditions</div>
    <div class="chart-legend"><div class="chart-lg"><div class="chart-dot" style="background:#ff9f43"></div>Temp ¬∞C</div><div class="chart-lg"><div class="chart-dot" style="background:var(--rain)"></div>Humidity %</div><div class="chart-lg"><div class="chart-dot" style="background:#ffd700"></div>UV Index</div><div class="chart-lg"><div class="chart-dot" style="background:rgba(255,107,107,.3)"></div>Danger ‚â•32¬∞C</div></div>
    <div class="chart-wrap" id="chart"></div></div>
  <div class="card"><div class="card-title">Activity Guide</div><div class="act-list" id="acts"></div></div>
  <footer class="footer"><a href="https://mapsplatform.google.com/maps-products/weather/">Google Weather API</a> ¬∑ <a href="https://open-meteo.com/">Open-Meteo</a> ¬∑ AAP Guidelines</footer>
</div>
<script>
const tip=document.getElementById('tip');
function sT(e,h){tip.innerHTML=h;tip.classList.add('on');tip.style.left=Math.min(e.clientX+12,innerWidth-250)+'px';tip.style.top=(e.clientY-10)+'px'}
function hT(){tip.classList.remove('on')}
window.sT=sT;window.hT=hT;
function gS(hi){if(hi>=32)return'danger';if(hi>=29)return'caution';return'safe'}
function sC(s){return s==='danger'?'var(--danger)':s==='caution'?'var(--caution)':'var(--safe)'}
function sLabel(s){return s==='danger'?'DANGER':s==='caution'?'CAUTION':'SAFE'}
function fD(ds){return new Date(ds+'T00:00:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})}
function wI(c){if(typeof c==='string'){if(c.includes('CLEAR')||c.includes('SUNNY'))return'‚òÄÔ∏è';if(c.includes('CLOUD'))return'‚òÅÔ∏è';if(c.includes('RAIN')||c.includes('DRIZZLE'))return'üåßÔ∏è';if(c.includes('THUNDER'))return'‚õàÔ∏è';if(c.includes('FOG'))return'üå´Ô∏è';return'‚õÖ'}if(c<=1)return'‚òÄÔ∏è';if(c<=3)return'‚õÖ';if(c<=48)return'üå´Ô∏è';if(c<=67)return'üåßÔ∏è';if(c<=77)return'üå®Ô∏è';if(c<=82)return'üå¶Ô∏è';if(c>=95)return'‚õàÔ∏è';return'üå§Ô∏è'}

const GOOGLE_KEY='AIzaSyDrV-tWEvw6-bq8_ZnHcxaYdWB2yoMC99o';
let fd=null,selDay=0,dataSource='';
let LOC={lat:7.88,lon:98.39,name:'Phuket, Thailand',tz:'Asia/Bangkok'};
function isToday(ds){return ds===new Date().toLocaleDateString('en-CA',{timeZone:LOC.tz})}

// Location
async function searchLocation(){const q=document.getElementById('loc-input').value.trim();if(!q)return;const btn=document.getElementById('loc-btn');btn.disabled=true;btn.textContent='‚Ä¶';
try{const res=await fetch(`https://maps.googleapis.com/maps/api/geocode/json?key=${GOOGLE_KEY}&address=${encodeURIComponent(q)}`);const data=await res.json();
if(data.results?.length){const r=data.results[0];LOC.lat=r.geometry.location.lat;LOC.lon=r.geometry.location.lng;LOC.name=r.formatted_address;
try{const tz=await(await fetch(`https://maps.googleapis.com/maps/api/timezone/json?key=${GOOGLE_KEY}&location=${LOC.lat},${LOC.lon}&timestamp=${Math.floor(Date.now()/1000)}`)).json();LOC.tz=tz.timeZoneId||'UTC'}catch(e){}
document.getElementById('loc-input').value=LOC.name;document.getElementById('header-loc').textContent=LOC.name;init()}else{alert('Location not found')}}catch(e){alert(e.message)}btn.disabled=false;btn.textContent='Search'}
function useMyLocation(){if(!navigator.geolocation)return alert('Geolocation not supported');navigator.geolocation.getCurrentPosition(async p=>{LOC.lat=p.coords.latitude;LOC.lon=p.coords.longitude;
try{const r=await(await fetch(`https://maps.googleapis.com/maps/api/geocode/json?key=${GOOGLE_KEY}&latlng=${LOC.lat},${LOC.lon}`)).json();LOC.name=r.results?.[0]?.formatted_address||`${LOC.lat.toFixed(2)}, ${LOC.lon.toFixed(2)}`;
const tz=await(await fetch(`https://maps.googleapis.com/maps/api/timezone/json?key=${GOOGLE_KEY}&location=${LOC.lat},${LOC.lon}&timestamp=${Math.floor(Date.now()/1000)}`)).json();LOC.tz=tz.timeZoneId||'UTC'}catch(e){LOC.name=`${LOC.lat.toFixed(2)}, ${LOC.lon.toFixed(2)}`}
document.getElementById('loc-input').value=LOC.name;document.getElementById('header-loc').textContent=LOC.name;init()},()=>alert('Location denied'))}
document.getElementById('loc-input').addEventListener('keydown',e=>{if(e.key==='Enter')searchLocation()});

// Parsers
function parseGoogle(hJson,dJson){const hours=hJson.forecastHours||[],dd=dJson.forecastDays||[],dm={};
hours.forEach(h=>{const dt=h.displayDateTime,ds=`${dt.year}-${String(dt.month).padStart(2,'0')}-${String(dt.day).padStart(2,'0')}`;
if(!dm[ds])dm[ds]=[];const t=h.temperature?.degrees??0,hu=h.relativeHumidity??0,uv=h.uvIndex??0,
hi=h.heatIndex?.degrees??h.feelsLikeTemperature?.degrees??t,pr=h.precipitation?.probability?.percent??0,wc=h.weatherCondition?.type||'';
dm[ds].push({hour:dt.hours,temp:t,humidity:hu,uv,apparent:Math.round(hi*10)/10,precip:pr,wc,safety:gS(hi)})});
const days=[],dates=Object.keys(dm).sort();
dates.forEach(date=>{const hrs=dm[date].sort((a,b)=>a.hour-b.hour);if(hrs.length<6)return;
const full=[];for(let h=0;h<24;h++){const ex=hrs.find(x=>x.hour===h);if(ex)full.push(ex);else{const n=hrs.reduce((a,b)=>Math.abs(b.hour-h)<Math.abs(a.hour-h)?b:a);full.push({...n,hour:h})}}
const temps=full.map(h=>h.temp).filter(t=>t>0);
const m=dd.find(d=>{const x=d.displayDate;return`${x.year}-${String(x.month).padStart(2,'0')}-${String(x.day).padStart(2,'0')}`===date});
days.push({date,hours:full,mx:m?.maxTemperature?.degrees??Math.max(...temps),mn:m?.minTemperature?.degrees??Math.min(...temps),uvMx:Math.max(...full.map(h=>h.uv)),precipSum:0})});return days}

function parseOpenMeteo(j){const days=[];for(let d=0;d<j.daily.time.length;d++){const hours=[];for(let h=0;h<24;h++){const i=d*24+h;
hours.push({hour:h,temp:j.hourly.temperature_2m[i],humidity:j.hourly.relative_humidity_2m[i],uv:Math.round((j.hourly.uv_index[i]||0)*10)/10,
apparent:Math.round(j.hourly.apparent_temperature[i]*10)/10,precip:j.hourly.precipitation_probability[i]||0,wc:j.hourly.weathercode[i]||0,
safety:gS(j.hourly.apparent_temperature[i])})}
days.push({date:j.daily.time[d],hours,mx:j.daily.temperature_2m_max[d],mn:j.daily.temperature_2m_min[d],uvMx:j.daily.uv_index_max[d],precipSum:j.daily.precipitation_sum[d]})}return days}

// Embedded fallback
const EB={"hourly":{"time":[],"temperature_2m":[28.2,27.9,28,28.1,28,27.9,27.9,27.8,27.8,27.9,28.1,28,27.9,27.8,27.8,27.9,28,27.9,27.9,28,28.1,28.2,28.3,28.2,28.2,28.2,28.1,28.1,27.9,27.8,27.9,27.9,27.9,28,28.1,28.2,28.5,28.8,28.8,28.8,28.9,28.9,28.9,29,29,29,29.1,29.1,29,28.9,28.9,28.8,28.6,28.4,28.3,28.3,28.3,28.5,28.7,28.9,28.9,28.9,28.9,29.1,29.1,29.3,29.2,29.2,29.3,29.2,29,29.1,29.1,28.9,29,29,28.9,28.7,28.6,28.5,28.5,28.7,28.8,28.8,28.9,29,29.1,29.2,29.3,29.3,29.3,29.2,29.3,29.3,29.3,29.2,29,28.9,28.9,28.9,28.9,28.9,28.8,28.8,28.8,28.8,28.9,28.8,28.8,28.8,28.8,28.9,29,29,29,29,29,29,29,28.9,28.9,28.9,28.7,28.7,28.6,28.7,28.8,28.8,28.9,28.9,28.9,28.9,28.8,28.8,28.8,28.9,28.9,28.9,28.9,28.9,29,29,29.1,29.1,29,29,28.9,28.8,28.7,28.5,28.3,28.1,28.2,28.3,28.5,28.7,28.9,29.1,29.1,29,28.9,29,29.1,29.1,29.1,29.1,29,28.9],"relative_humidity_2m":[82,83,83,81,81,81,81,82,82,81,80,82,83,84,84,84,83,83,83,83,82,81,80,81,81,81,81,82,83,83,82,82,81,81,81,80,79,76,76,76,76,77,79,79,79,79,79,79,78,79,78,78,79,80,81,81,80,79,78,77,78,80,80,79,80,78,78,78,77,78,79,79,79,80,77,76,76,78,79,79,79,77,77,78,79,80,80,79,78,78,78,78,77,76,75,75,77,77,76,75,74,74,74,74,74,74,74,74,73,73,72,71,71,71,72,73,73,73,73,73,73,73,72,73,74,74,73,73,73,73,73,74,74,75,75,74,74,74,73,73,72,71,70,70,70,70,70,71,72,74,76,77,76,74,72,72,72,72,73,74,75,75,74,73,73,73,74,75],"apparent_temperature":[33.2,33.2,33.4,33.3,33.2,33.1,33.2,33.4,33.3,33.3,33.2,33.3,33.8,34,33.6,33.6,32.9,32.7,32.8,33,33.1,33.2,33.1,33.2,33.3,33.3,33.4,33.6,33.6,33.5,33.5,33.6,33.5,33.5,33.6,34,34.4,34.4,34.6,34.3,33.7,33.4,33.6,33.7,33.8,33.9,34.1,34.2,34.1,34.1,34.1,33.9,33.8,33.7,33.9,34,33.8,33.9,34.1,35.2,35.5,35.7,35.4,34.6,34.2,34.2,33.9,33.9,34,34,34.1,34.4,34.4,34.4,34.1,34,33.9,34,33.9,34,34.1,34.1,34.3,35.6,36.1,36,35.8,35.3,34.5,34.2,34.1,33.9,33.7,33.6,33.4,33.2,33.4,33.1,32.9,32.6,32.4,32.5,32.6,32.7,32.9,33.1,33.1,33.5,33.3,33.2,33.1,32.8,32.3,31.8,32.2,32.5,32.5,32.6,32.7,32.8,33.2,33.3,32.6,32.6,32.7,32.9,33,33.2,33.2,33.2,33.1,33.6,33.7,33.8,33.7,33.1,32.6,32.5,32.5,32.6,32.7,32.8,33,33.1,33.2,33.2,33.1,33.2,33.1,33,32.8,32.6,32.5,32.6,32.8,34.4,35.2,35.3,35,34.3,33.3,33.1,33.2,33.3,33.5,33.6,33.7,33.6],"uv_index":[0,0,0,0,0,0,0,0,.75,2.55,4.85,7,8.5,9.15,8.8,7.6,5.65,3.35,1.3,.1,0,0,0,0,0,0,0,0,0,0,0,0,.8,2.65,4.95,7.05,8.55,9.15,8.85,7.6,5.7,3.4,1.2,.1,0,0,0,0,0,0,0,0,0,0,0,0,.8,2.7,5,7.1,8.55,9.2,8.85,7.65,5.7,3.4,1.3,.1,0,0,0,0,0,0,0,0,0,0,0,0,.7,2.4,4.55,7.1,8.5,8.95,8.8,7.65,5.55,3.2,1.2,.1,0,0,0,0,0,0,0,0,0,0,0,.05,.8,2.6,4.8,6.9,8.4,9.05,8.25,7.5,5.1,2.95,1.2,.1,0,0,0,0,0,0,0,0,0,0,0,0,.6,1.45,2.65,4.45,6.6,8.05,8.45,8.2,7.4,5.7,3.4,1.6,.7,.25,0,0,0,0,0,0,0,0,0,0,.7,1.75,2.9,4.3,5.8,6.9,7.55,7.75,7.3,5.7,3.4,1.6,.7,.25,0,0],"precipitation_probability":[45,45,43,53,48,50,45,55,63,65,68,78,68,75,63,53,48,25,25,18,18,23,23,18,20,25,23,23,25,18,13,15,23,20,23,35,35,33,18,20,13,5,3,5,4,4,5,8,13,18,24,29,33,33,31,28,25,22,20,20,20,20,19,17,15,12,11,10,10,12,13,15,17,18,18,19,19,18,18,18,18,18,18,18,18,18,19,20,21,22,23,23,22,21,19,17,16,15,16,17,19,21,23,23,22,21,19,16,14,13,14,13,11,11,10,10,11,12,13,15,17,19,21,23,25,27,28,28,28,27,26,24,22,20,18,17,15,14,13,13,14,15,16,18,20,23,25,27,29,31,32,33,33,33,32,31,30,29,27,26,25,24,23,23,23,24,25,26],"weathercode":[80,80,80,2,2,2,2,3,80,2,2,2,80,80,80,80,80,2,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,2,3,3,3,3,3,3,3,1,3,3,2,2,3,3,80,2,1,1,2,1,1,1,1,3,3,3,3,3,3,3,3,3,3,3,2,2,1,2,3,1,1,1,1,1,1,1,1,1,2,2,2,3,3,3,3,3,3,2,2,2,1,1,1,2,2,2,1,1,1,0,0,0,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1,1,1,1,1,1,2,2,2,1,1,1,2,2,2,1,1,1,0,0,0,2,2,2,1,1,1,2,2,2,2,2,2,1]},"daily":{"time":["2026-02-28","2026-03-01","2026-03-02","2026-03-03","2026-03-04","2026-03-05","2026-03-06"],"temperature_2m_max":[28.3,29.1,29.3,29.3,29,29.1,29.1],"temperature_2m_min":[27.8,27.8,28.3,28.5,28.8,28.6,28.1],"uv_index_max":[9.15,9.15,9.2,8.95,9.05,8.45,7.75],"precipitation_sum":[4.9,.4,.7,0,2.1,0,0]}};

// Init
async function init(){
try{const dR=await fetch(`https://weather.googleapis.com/v1/forecast/days:lookup?key=${GOOGLE_KEY}&location.latitude=${LOC.lat}&location.longitude=${LOC.lon}&days=7`);if(!dR.ok)throw new Error(dR.status);const dJ=await dR.json();let all=[];
let url=`https://weather.googleapis.com/v1/forecast/hours:lookup?key=${GOOGLE_KEY}&location.latitude=${LOC.lat}&location.longitude=${LOC.lon}&hours=168`;
for(let p=0;p<5;p++){const r=await fetch(url);if(!r.ok)throw new Error(r.status);const j=await r.json();if(j.forecastHours)all=all.concat(j.forecastHours);if(!j.nextPageToken)break;
url=`https://weather.googleapis.com/v1/forecast/hours:lookup?key=${GOOGLE_KEY}&location.latitude=${LOC.lat}&location.longitude=${LOC.lon}&hours=168&pageToken=${j.nextPageToken}`}
fd={days:parseGoogle({forecastHours:all},dJ),at:new Date().toLocaleString('en-GB',{timeZone:LOC.tz})};dataSource='google';return renderAll()}catch(e){console.log('Google:',e.message)}
try{const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LOC.lat}&longitude=${LOC.lon}&hourly=temperature_2m,relative_humidity_2m,apparent_temperature,uv_index,precipitation_probability,weathercode&daily=temperature_2m_max,temperature_2m_min,uv_index_max,precipitation_sum&forecast_days=7&timezone=${encodeURIComponent(LOC.tz)}`);
if(r.ok){const j=await r.json();fd={days:parseOpenMeteo(j),at:new Date().toLocaleString('en-GB',{timeZone:LOC.tz})};dataSource='openmeteo';return renderAll()}}catch(e){console.log('OM:',e.message)}
fd={days:parseOpenMeteo(EB),at:'28/02/2026 (snapshot)'};dataSource='embedded';renderAll()}

function renderAll(){const src=document.getElementById('src-line');
if(dataSource==='google')src.innerHTML=`<span class="src-tag google">GOOGLE AI</span> ${LOC.name} ¬∑ ${fd.at}`;
else if(dataSource==='openmeteo')src.innerHTML=`<span class="src-tag meteo">OPEN-METEO</span> ${LOC.name} ¬∑ ${fd.at}`;
else src.innerHTML=`<span class="src-tag embed">SNAPSHOT</span> ${fd.at}`;
const ti=fd.days.findIndex(d=>isToday(d.date));selDay=ti>=0?ti:0;rNow();rTabs();rHourly();rSafety();rChart();rActs()}

function rNow(){const el=document.getElementById('now-card');if(!fd?.days.length){el.style.display='none';return}
const d=fd.days[selDay],nowH=isToday(d.date)?new Date().getHours():12,cur=d.hours[nowH]||d.hours[12];const s=cur.safety,sc=sC(s);el.style.display='block';
el.innerHTML=`<div class="now-top"><div><div class="now-temp">${cur.temp.toFixed(0)}¬∞</div><div class="now-label">${isToday(d.date)?'Now ¬∑ '+String(nowH).padStart(2,'0')+':00':fD(d.date)}</div><div class="now-status ${s}"><div class="now-status-dot"></div>${sLabel(s)}</div></div><div class="now-right"><div class="now-hi">Heat Index</div><div class="now-hi-val" style="color:${sc}">${cur.apparent}¬∞</div><div class="now-label">Feels like</div></div></div><div class="now-grid"><div class="now-stat"><div class="now-stat-icon">üíß</div><div class="now-stat-val">${cur.humidity}%</div><div class="now-stat-lbl">Humidity</div></div><div class="now-stat"><div class="now-stat-icon">‚òÄÔ∏è</div><div class="now-stat-val">${cur.uv}</div><div class="now-stat-lbl">UV Index</div></div><div class="now-stat"><div class="now-stat-icon">üåßÔ∏è</div><div class="now-stat-val">${cur.precip}%</div><div class="now-stat-lbl">Rain</div></div><div class="now-stat"><div class="now-stat-icon">${wI(cur.wc)}</div><div class="now-stat-val">${Math.round(d.mx)}¬∞/${Math.round(d.mn)}¬∞</div><div class="now-stat-lbl">Hi / Lo</div></div></div>`}

function rTabs(){document.getElementById('tabs').innerHTML=fd.days.map((d,i)=>{const t=isToday(d.date);
return`<div class="tab ${i===selDay?'on':''} ${t?'today':''}" onclick="selD(${i})">${fD(d.date).split(' ')[0]}${t?' <span class="badge">TODAY</span>':''}<span class="td">${d.date.slice(5)}</span><span class="tt">${Math.round(d.mx)}¬∞/${Math.round(d.mn)}¬∞</span></div>`}).join('')}

function rHourly(){const d=fd.days[selDay],nowH=isToday(d.date)?new Date().getHours():-1;
document.getElementById('hourly-area').innerHTML=`<div class="hourly-scroll">${d.hours.map(h=>{const isNow=h.hour===nowH;
return`<div class="hour-col ${h.safety} ${isNow?'now':''}"><div class="hour-time">${isNow?'Now':String(h.hour).padStart(2,'0')+'h'}</div><div class="hour-icon">${wI(h.wc)}</div><div class="hour-temp">${Math.round(h.temp)}¬∞</div><div class="hour-hi" style="color:${sC(h.safety)}">${h.apparent}¬∞</div>${h.precip>0?`<div class="hour-rain">${h.precip}%</div>`:''}</div>`}).join('')}</div>`}

function rSafety(){const d=fd.days[selDay],sH=d.hours.filter(h=>h.safety==='safe').length,cH=d.hours.filter(h=>h.safety==='caution').length,dH=d.hours.filter(h=>h.safety==='danger').length;
let bar='<div class="safety-bar">';let segs=[],cur={s:d.hours[0].safety,n:1};
for(let i=1;i<24;i++){if(d.hours[i].safety===cur.s)cur.n++;else{segs.push(cur);cur={s:d.hours[i].safety,n:1}}}segs.push(cur);
segs.forEach(seg=>{bar+=`<div class="safety-seg ${seg.s}" style="width:${(seg.n/24*100).toFixed(1)}%">${seg.n>2?seg.n+'h':''}</div>`});
bar+='</div><div class="safety-labels">';for(let i=0;i<=23;i+=3)bar+=`<span class="safety-lbl">${String(i).padStart(2,'0')}h</span>`;bar+='</div>';
document.getElementById('safety-bar').innerHTML=bar;
document.getElementById('stats-row').innerHTML=`<div class="stat-box"><div class="stat-val" style="color:var(--safe)">${sH}h</div><div class="stat-lbl">Safe</div></div><div class="stat-box"><div class="stat-val" style="color:var(--caution)">${cH}h</div><div class="stat-lbl">Caution</div></div><div class="stat-box"><div class="stat-val" style="color:var(--danger)">${dH}h</div><div class="stat-lbl">Danger</div></div><div class="stat-box"><div class="stat-val">${Math.round(fd.days[selDay].mn)}‚Äì${Math.round(fd.days[selDay].mx)}¬∞</div><div class="stat-lbl">Range</div></div>`}

function rChart(){const hrs=fd.days[selDay].hours,W=700,H=280,P={t:20,r:50,b:36,l:40},cw=W-P.l-P.r,ch=H-P.t-P.b;
const tMn=Math.floor(Math.min(...hrs.map(h=>h.temp)))-2,tMx=Math.ceil(Math.max(...hrs.map(h=>h.temp)))+2;
const hMn=30,hMx=100,uMx=14;
const xP=h=>P.l+(h/23)*cw,yT=t=>P.t+(1-(t-tMn)/(tMx-tMn))*ch,yH=h=>P.t+(1-(h-hMn)/(hMx-hMn))*ch;
let svg=`<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;
svg+=`<defs><linearGradient id="tg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#ff9f43" stop-opacity=".3"/><stop offset="100%" stop-color="#ff9f43" stop-opacity="0"/></linearGradient><linearGradient id="hg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#70b8ff" stop-opacity=".2"/><stop offset="100%" stop-color="#70b8ff" stop-opacity="0"/></linearGradient></defs>`;
if(tMx>=32){const dy=yT(32);svg+=`<rect x="${P.l}" y="${P.t}" width="${cw}" height="${Math.max(0,dy-P.t)}" fill="rgba(255,107,107,.06)" rx="4"/>`;svg+=`<line x1="${P.l}" y1="${dy}" x2="${P.l+cw}" y2="${dy}" stroke="rgba(255,107,107,.3)" stroke-dasharray="5,3"/>`;svg+=`<text x="${P.l+cw-4}" y="${dy-4}" fill="rgba(255,107,107,.5)" font-size="9" text-anchor="end" font-family="Nunito" font-weight="700">32¬∞ danger</text>`}
for(let t=Math.ceil(tMn/2)*2;t<=tMx;t+=2){const y=yT(t);svg+=`<line x1="${P.l}" y1="${y}" x2="${P.l+cw}" y2="${y}" stroke="rgba(255,255,255,.06)"/>`;svg+=`<text x="${P.l-6}" y="${y+4}" fill="rgba(255,255,255,.35)" font-size="10" text-anchor="end" font-family="JetBrains Mono">${t}¬∞</text>`}
for(let h=40;h<=100;h+=15)svg+=`<text x="${P.l+cw+6}" y="${yH(h)+4}" fill="rgba(112,184,255,.4)" font-size="10" font-family="JetBrains Mono">${h}%</text>`;
for(let h=0;h<=23;h+=3)svg+=`<text x="${xP(h)}" y="${H-6}" fill="rgba(255,255,255,.3)" font-size="10" text-anchor="middle" font-family="JetBrains Mono">${String(h).padStart(2,'0')}h</text>`;
let hp=`M${xP(0)},${yH(hrs[0].humidity)}`;hrs.forEach((d,i)=>{if(i>0)hp+=` L${xP(d.hour)},${yH(d.humidity)}`});
svg+=`<path d="${hp} L${xP(23)},${P.t+ch} L${xP(0)},${P.t+ch} Z" fill="url(#hg)"/>`;svg+=`<path d="${hp}" fill="none" stroke="#70b8ff" stroke-width="1.5" opacity=".5"/>`;
let tp=`M${xP(0)},${yT(hrs[0].temp)}`;hrs.forEach((d,i)=>{if(i>0)tp+=` L${xP(d.hour)},${yT(d.temp)}`});
svg+=`<path d="${tp} L${xP(23)},${P.t+ch} L${xP(0)},${P.t+ch} Z" fill="url(#tg)"/>`;svg+=`<path d="${tp}" fill="none" stroke="#ff9f43" stroke-width="2.5" stroke-linejoin="round"/>`;
hrs.forEach(d=>{if(d.uv>0){const bw=cw/24*.35,bh=ch*(d.uv/uMx),bx=xP(d.hour)-bw/2,by=P.t+ch-bh,uc=d.uv>=8?'#ff6b6b':d.uv>=5?'#ffd700':'#4cd9a0';svg+=`<rect x="${bx}" y="${by}" width="${bw}" height="${bh}" fill="${uc}" opacity=".3" rx="2"/>`}});
hrs.forEach(d=>{const cx=xP(d.hour),cy=yT(d.temp),c=d.safety==='danger'?'#ff6b6b':d.safety==='caution'?'#ffc857':'#4cd9a0';
svg+=`<circle cx="${cx}" cy="${cy}" r="3" fill="${c}" opacity=".85"/>`;svg+=`<circle cx="${cx}" cy="${cy}" r="12" fill="transparent" onmouseenter="sTipH(event,${selDay},${d.hour})" onmouseleave="hT()"/>`});
if(isToday(fd.days[selDay].date)){const nh=new Date().getHours()+new Date().getMinutes()/60,nx=P.l+(nh/23)*cw;
svg+=`<line x1="${nx}" y1="${P.t}" x2="${nx}" y2="${P.t+ch}" stroke="rgba(255,255,255,.5)" stroke-width="1.5" stroke-dasharray="4,3"/>`;svg+=`<text x="${nx}" y="${P.t-4}" fill="rgba(255,255,255,.7)" font-size="10" text-anchor="middle" font-family="Nunito" font-weight="800">NOW</text>`}
svg+=`</svg>`;document.getElementById('chart').innerHTML=svg}

window.sTipH=function(e,di,hr){const d=fd.days[di].hours[hr];
sT(e,`<div class="tt-title">${fd.days[di].date} ¬∑ ${String(hr).padStart(2,'0')}:00</div><div class="tt-r"><span>Temp</span><span class="v" style="color:#ff9f43">${d.temp.toFixed(1)}¬∞C</span></div><div class="tt-r"><span>Heat Index</span><span class="v" style="color:${sC(d.safety)}">${d.apparent}¬∞C</span></div><div class="tt-r"><span>Humidity</span><span class="v" style="color:#70b8ff">${d.humidity}%</span></div><div class="tt-r"><span>UV</span><span class="v" style="color:#ffd700">${d.uv}</span></div><div class="tt-r"><span>Rain</span><span class="v">${d.precip}%</span></div><div style="margin-top:6px;font-weight:800;color:${sC(d.safety)}">${sLabel(d.safety)}</div>`)};

const acts=[
{t:"05:30‚Äì07:00",n:"üåÖ Sunrise",d:"Coolest window ‚Äî ideal for outdoor activity",s:"safe",tg:["Cool","UV 0"]},
{t:"07:00‚Äì09:00",n:"üèä Morning Active",d:"Comfortable for exercise, swimming, walking",s:"safe",tg:["Mild","SPF"]},
{t:"09:00‚Äì10:00",n:"üö∂ Transition",d:"Heat rising ‚Äî last comfortable outdoor window",s:"caution",tg:["Warming","Shade"]},
{t:"10:00‚Äì15:00",n:"‚ùÑÔ∏è Indoors Only",d:"Peak heat index ‚Äî stay in air conditioning",s:"danger",tg:["HI 32¬∞C+","AC"]},
{t:"15:00‚Äì16:30",n:"üßò Shaded Rest",d:"Heat easing ‚Äî shade structures only",s:"caution",tg:["~32¬∞C","Shade"]},
{t:"16:30‚Äì18:30",n:"üèñÔ∏è Golden Hour",d:"Great outdoor window ‚Äî dropping temps",s:"safe",tg:["Cooling","UV 0-2"]},
{t:"18:30‚Äì20:30",n:"üçΩÔ∏è Evening Out",d:"Cool temps ‚Äî dining, markets, strolling",s:"safe",tg:["Cool","UV 0"]},
{t:"20:30‚Äì22:00",n:"üåô Night",d:"Comfortable ‚Äî evening walks, relaxing",s:"safe",tg:["Cool","Calm"]}];
function rActs(){document.getElementById('acts').innerHTML=acts.map(a=>`<div class="act-item"><div class="act-dot ${a.s}"></div><div class="act-time">${a.t}</div><div class="act-name">${a.n}</div><div class="act-tags">${a.tg.map(t=>`<span class="act-tag">${t}</span>`).join('')}</div></div>`).join('')}

window.selD=function(i){selDay=i;rNow();rTabs();rHourly();rSafety();rChart()};
init();
</script>
</body>
</html>
